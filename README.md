# Астрологиня maker

**Первоначальная задача:** Парсинг гороскопов с определенного сайта, дальнейшая пересылка в телеграм канал по заданному времени. Плюс бонус - генерация видео с текстом гороскопов

**Текущая реализация:** Убрана рассылка сообщений в телеграм, весь функционал сконцентрирован на генерации "видео-креативов"

Генерация креативов состоит из двух основных частей - геттер данных и непосредственно генератор.

---

Геттер реализует интерфейс **"CreativeObjectGetterInterface"**, который всегда возвращает объект, содержащий всю нужную информацию для генератора.
Геттер может получать эту информацию различными способами, в зависимости от реализации, на данный момент реализована два типа геттеров: Получение данных из модели, получение данных из настроек креативов.

Чуть подробнее разберем каждый из геттеров.

**Геттер из модели** - ищем запись в базе, для которой еще не было создано видео, если такой нет возвращаем null. В случае неполноты данных модели для заполнения объекта выбрасывается exception 

**Геттер из настроек креатива** - при настройке креатива заполняется таблица типа "ключ - значение". Из них ищутся такие записи, для которых еще не было создано видео. Если такой нет, то действуем аналогично геттеру из модели.

---

Генератор реализует интерфейс "CreativeGeneratorInterface", который берет данные из объекта, полученного от геттера, и на их основе генерирует некоторое видео.
Реализовано два типа генераторов: текст на анимированном фоне, анимированный список на анимированном фоне.
Для генерации видео используется обертка над ffmpeg, для добавления текста в начале создается изображение с необходимым текстом, потом изображение помещается на видео через метод добавления ватермарки на видео в ffmpeg.

Рассмотрим каждый генератор подробнее: 

**Генератор текста с анимированным фоном** - используется сервис, который создает изображение из текста, причем севрис уммет располагать текст в несколько строк, если это необходимо. Затем созданное изображение накладывается ватермаркой на видео.

**Генератор анимированного списка с анимированным фоном** - здесь процесс генерации чуть сложнее. В начале сервис по созданию изображения из текста создает N "кадров" анимации перечисления текста. Затем видео, согласно настройкам режется на N-1 частей согласно заданной длительности. 
Последняя N-ая часть имеет остаточную длину видео. Например, если видео длительностью 15 секунд, а длительность одного "кадра" 1 секунду, кадров 4, то 3 части видео будут длительность 1 секунду каждая, а 4 часть будет длительностью 12 секунд. Затем все нарезки склеиваются обратно и получается видео с анимированным текст.

---
 
И геттеры и генераторы могут реализовывать интерфейс "CreativeFieldsContainer", позволяющий классам возвращать класс полей настроек, который используется при построении формы настроек креативов.

При создании настроек креативов, необходимо выбрать какой геттер и какой генератор будут использоваться. 
После выбора подгружаются поля настроек для выбранного геттера и генератора 

Таким образом мы получаем достаточно гибкую конфигурацию для генерации "креативов" (откуда брать данные и как их обрабатывать)

Данный проект предназначался для генерации видео для тиктока (инстаграма), в данный момент не используется.
* Админка - https://orchid.software/en/
* Обертка ffmpeg - https://github.com/protonemedia/laravel-ffmpeg
* Работа с изображениями - http://image.intervention.io/
* Проект деплоился на https://heroku.com/
* Для хранения файлов использовалось хранилище от https://cloud.yandex.ru/
* Отправка сообщений в телеграм - https://botman.io/2.0/welcome
